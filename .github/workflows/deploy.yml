name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment target (staging|prod)"
        required: true
        default: "prod"
      ec2_host:
        description: "EC2 instance IP or domain (e.g., 13.37.245.222 or api.example.com)"
        required: true
      ec2_port:
        description: "Backend API port"
        required: false
        default: "8000"
      backoffice_port:
        description: "Backoffice port"
        required: false
        default: "5173"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare artifact
        run: |
          echo "Preparing deployment bundle"
          tar -czf app.tar.gz \
            docker-compose.yml \
            .env.example \
            backend \
            apps/backoffice \
            docs

      - name: Copy bundle to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app.tar.gz"
          target: "/tmp"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          EC2_HOST: ${{ inputs.ec2_host }}
          EC2_PORT: ${{ inputs.ec2_port }}
          BACKOFFICE_PORT: ${{ inputs.backoffice_port }}
          DB_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_HOST,EC2_PORT,BACKOFFICE_PORT,DB_URL,SECRET_KEY
          script: |
            set -euo pipefail

            # Navigate to deployment directory
            DEPLOY_DIR="/opt/chrona"
            sudo mkdir -p $DEPLOY_DIR
            sudo chown $USER:$USER $DEPLOY_DIR

            # Extract bundle
            cd $DEPLOY_DIR
            tar -xzf /tmp/app.tar.gz
            rm -f /tmp/app.tar.gz

            # List extracted files
            echo "Extracted files:"
            ls -la
            echo ""

            # Verify docker-compose.yml exists
            if [ ! -f "docker-compose.yml" ]; then
              echo "ERROR: docker-compose.yml not found in $DEPLOY_DIR"
              exit 1
            fi

            # Create .env file with environment variables (with variable substitution)
            cat > .env <<ENVMARK
            EC2_HOST=$EC2_HOST
            EC2_PORT=$EC2_PORT
            BACKOFFICE_PORT=$BACKOFFICE_PORT
            DATABASE_URL=$DB_URL
            SECRET_KEY=$SECRET_KEY
            ALLOWED_ORIGINS=http://$EC2_HOST:$BACKOFFICE_PORT,http://$EC2_HOST:$EC2_PORT
            VITE_API_URL=http://$EC2_HOST:$EC2_PORT
            ALLOW_CREDENTIALS=false
            ALLOWED_METHODS=*
            ALLOWED_HEADERS=*
            ACCESS_TOKEN_EXPIRE_MINUTES=60
            JWT_PRIVATE_KEY_PATH=/app/jwt_private_key.pem
            JWT_PUBLIC_KEY_PATH=/app/jwt_public_key.pem
            POSTGRES_DB=chrona
            POSTGRES_USER=chrona
            POSTGRES_PASSWORD=chrona
            ENVMARK

            # Show .env file for debugging
            echo "Generated .env file:"
            cat .env
            echo ""

            # Generate JWT keys if they don't exist
            echo "Checking for JWT keys..."
            if [ ! -f "backend/jwt_private_key.pem" ] || [ ! -f "backend/jwt_public_key.pem" ]; then
              echo "JWT keys not found, generating..."

              # Create backend directory if it doesn't exist
              mkdir -p backend

              # Generate EC private key (ES256)
              openssl ecparam -name prime256v1 -genkey -noout -out backend/jwt_private_key.pem

              # Extract public key from private key
              openssl ec -in backend/jwt_private_key.pem -pubout -out backend/jwt_public_key.pem

              echo "JWT keys generated:"
              ls -la backend/jwt_*.pem
            else
              echo "JWT keys already exist"
            fi
            echo ""

            # Install Docker and docker-compose if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo usermod -aG docker $USER
            fi

            # Install docker-compose if not present (standalone binary)
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing docker-compose..."
              DOCKER_COMPOSE_URL="https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)"
              echo "Downloading from: $DOCKER_COMPOSE_URL"
              if sudo curl -L "$DOCKER_COMPOSE_URL" -o /usr/local/bin/docker-compose 2>&1; then
                sudo chmod +x /usr/local/bin/docker-compose
                echo "docker-compose installed successfully:"
                docker-compose --version
              else
                echo "ERROR: Failed to download docker-compose from $DOCKER_COMPOSE_URL"
                echo "See MANUAL_EC2_SETUP.md for manual installation instructions"
                exit 1
              fi
            fi

            # Ensure docker is running
            sudo systemctl start docker 2>/dev/null || true
            sudo systemctl enable docker 2>/dev/null || true

            # Ensure docker group is available
            sudo usermod -aG docker $USER 2>/dev/null || true

            # Check Docker and docker-compose versions
            echo "Docker version:"
            docker --version
            echo "docker-compose version:"
            docker-compose --version
            echo ""

            # Build and start services using standard docker-compose.yml
            # Environment variables from .env will be automatically loaded
            echo "Starting services with docker-compose..."
            # Try without sudo first, then with sudo if it fails
            if docker-compose -f docker-compose.yml up -d --build 2>&1; then
              echo "Services started successfully"
            else
              echo "Trying with sudo..."
              sudo docker-compose -f docker-compose.yml up -d --build
            fi

            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 15

            # Check service status
            echo "Service status:"
            sudo docker-compose ps

            # Show logs
            echo "Backend logs (last 20 lines):"
            sudo docker-compose logs --tail=20 backend

            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            echo "Backend API: http://$EC2_HOST:$EC2_PORT"
            echo "Swagger UI: http://$EC2_HOST:$EC2_PORT/docs"
            echo "Backoffice: http://$EC2_HOST:$BACKOFFICE_PORT"
            echo "=========================================="

