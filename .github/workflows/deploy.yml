name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment target (staging|prod)"
        required: true
        default: "prod"
      ec2_host:
        description: "EC2 instance IP or domain (e.g., 13.37.245.222 or api.example.com)"
        required: true
      ec2_port:
        description: "Backend API port"
        required: false
        default: "8000"
      backoffice_port:
        description: "Backoffice port"
        required: false
        default: "5173"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare artifact
        run: |
          echo "Preparing deployment bundle"
          tar -czf app.tar.gz \
            docker-compose.yml \
            .env.example \
            backend \
            apps/backoffice \
            docs

      - name: Copy bundle to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app.tar.gz"
          target: "/tmp"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          EC2_HOST: ${{ inputs.ec2_host }}
          EC2_PORT: ${{ inputs.ec2_port }}
          BACKOFFICE_PORT: ${{ inputs.backoffice_port }}
          DB_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_HOST,EC2_PORT,BACKOFFICE_PORT,DB_URL,SECRET_KEY
          script: |
            set -euo pipefail

            # Navigate to deployment directory
            DEPLOY_DIR="/opt/chrona"
            sudo mkdir -p $DEPLOY_DIR
            sudo chown $USER:$USER $DEPLOY_DIR

            # Extract bundle
            cd $DEPLOY_DIR
            tar -xzf /tmp/app.tar.gz
            rm -f /tmp/app.tar.gz

            # Create .env file for backend
            cat > .env <<EOF
            EC2_HOST=$EC2_HOST
            EC2_PORT=$EC2_PORT
            BACKOFFICE_PORT=$BACKOFFICE_PORT
            DATABASE_URL=$DB_URL
            SECRET_KEY=$SECRET_KEY
            ALLOWED_ORIGINS=http://$EC2_HOST:$BACKOFFICE_PORT,http://$EC2_HOST:$EC2_PORT
            VITE_API_URL=http://$EC2_HOST:$EC2_PORT
            ALLOW_CREDENTIALS=false
            ALLOWED_METHODS=*
            ALLOWED_HEADERS=*
            ACCESS_TOKEN_EXPIRE_MINUTES=60
            JWT_PRIVATE_KEY_PATH=/app/jwt_private_key.pem
            JWT_PUBLIC_KEY_PATH=/app/jwt_public_key.pem
            POSTGRES_DB=chrona
            POSTGRES_USER=chrona
            POSTGRES_PASSWORD=chrona
            EOF

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io docker-compose
              sudo usermod -aG docker $USER
            fi

            # Ensure docker group is available
            sudo usermod -aG docker $USER 2>/dev/null || true
            newgrp docker 2>/dev/null || true

            # Build and start services using standard docker-compose.yml
            # Environment variables from .env will be automatically loaded
            docker compose up -d --build

            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 15

            # Check service status
            echo "Service status:"
            docker compose ps

            # Show logs
            echo "Backend logs (last 20 lines):"
            docker compose logs --tail=20 backend

            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            echo "Backend API: http://$EC2_HOST:$EC2_PORT"
            echo "Swagger UI: http://$EC2_HOST:$EC2_PORT/docs"
            echo "Backoffice: http://$EC2_HOST:$BACKOFFICE_PORT"
            echo "=========================================="

